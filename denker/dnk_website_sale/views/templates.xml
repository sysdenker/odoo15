<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="dnk_address_adicional" inherit_id="website_sale.address_b2b">
        <xpath expr="//t/div[2]" position="before">
            <t t-if="request.website.company_id.id == 1">
                <div>
                    <h4 class="o_page_header mt8"> Datos de Facturación:</h4>
                </div>
                <div class="w-100"/>
            </t>
        </xpath>
        <xpath expr="//t/div[2]" position="after">
            <t t-if="request.website.company_id.id == 1">
                <t t-if="mode == ('new', 'billing') or (mode == ('edit', 'billing') and (can_edit_vat or 'vat' in checkout and checkout['vat']))">
                    <div class="w-100"/>
                    <div t-attf-class="form-group #{error.get('dnk_l10n_mx_edi_usage') and 'o_has_error' or ''} col-lg-6">
                        <t t-if="'vat' in checkout and checkout['vat'] and not can_edit_vat" >
                            <label class="col-form-label font-weight-normal" for="dnk_l10n_mx_edi_usage">Usage</label>
                            <input type="text" name="dnk_l10n_mx_edi_usage" t-attf-class="form-control #{error.get('dnk_l10n_mx_edi_usage') and 'is-invalid' or ''}"
                                t-att-value="dnk_l10n_mx_edi_usage_val or False" t-att-readonly="'1'" />
                        </t>
                        <t t-if="can_edit_vat" >
                            <label class="col-form-label font-weight-normal" for="dnk_l10n_mx_edi_usage">Usage</label>
                            <select id="dnk_l10n_mx_edi_usage" name="dnk_l10n_mx_edi_usage"
                                t-attf-class="form-control #{error.get('dnk_l10n_mx_edi_usage') and 'is-invalid' or ''}">
                                <t t-foreach="dnk_l10n_mx_edi_usage_select" t-as="usage">
                                    <option t-att-value="usage[0]" t-att-selected="usage[0] == (dnk_l10n_mx_edi_usage or -1)">
                                        <t t-esc="usage[1]" />
                                    </option>
                                </t>
                            </select>
                        </t>
                    </div>
                </t>
            </t>
        </xpath>
    </template>

    <!-- solo si está instalado el tema de aviat-->
    <template id="dnk_website_cart_line_details" inherit_id="website_sale.cart_lines">
        <xpath expr="//table[@id='cart_products']" position="replace">
            <table class="mb16 table table-striped table-sm js_cart_lines" id="cart_products" t-if="website_sale_order and website_sale_order.website_order_line">
            <thead>
                <tr>
                    <th class="td-img">Product</th>
                    <th></th>
                    <th class="text-center td-qty">Quantity</th>
                    <th class="text-center td-price">Price</th>
                    <th class="text-center td-price">Unit of Measure</th>
                    <th class="text-center td-action"></th>
                </tr>
            </thead>
            <tbody>
                <t t-foreach="website_sale_order.website_order_line" t-as="line">
                    <tr t-att-class="'optional_product info' if line.linked_line_id else None">
                        <td colspan="2" t-if="not line.product_id.product_tmpl_id" class='td-img'></td>
                        <td align="center" t-if="line.product_id.product_tmpl_id" class='td-img'>
                            <span t-field="line.product_id.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'rounded o_image_64_max'}" />
                        </td>
                        <td t-if="line.product_id.product_tmpl_id" class='td-product_name'>
                            <div>
                                <t t-call="website_sale.cart_line_product_link">
                                    <strong t-field="line.name_short" />
                                </t>
                            </div>
                            <t t-call="website_sale.cart_line_description_following_lines">
                                <t t-set="div_class" t-value="'d-none d-md-block'"/>
                            </t>
                        </td>
                        <td class="text-center td-qty">
                            <div class="css_quantity input-group mx-auto">
                                <div class="input-group-prepend">
                                    <a t-attf-href="#" class="btn btn-link js_add_cart_json d-none d-md-inline-block" aria-label="Remove one" title="Remove one">
                                        <i class="fa fa-minus"></i>
                                    </a>
                                </div>
                                <input type="text" class="js_quantity form-control quantity" t-att-data-line-id="line.id" t-att-data-product-id="line.product_id.id" t-att-value="int(line.product_uom_qty) == line.product_uom_qty and int(line.product_uom_qty) or line.product_uom_qty" />
                                <div class="input-group-append">
                                    <a t-attf-href="#" class="btn btn-link float_left js_add_cart_json d-none d-md-inline-block" aria-label="Add one" title="Add one">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td class="text-center td-price" name="price">
                            <t t-set="combination" t-value="line.product_id.product_template_attribute_value_ids + line.product_no_variant_attribute_value_ids"/>
                            <t t-set="combination_info" t-value="line.product_id.product_tmpl_id._get_combination_info(combination, pricelist=website_sale_order.pricelist_id)"/>

                            <t t-set="list_price_converted" t-value="website.currency_id._convert(combination_info['list_price'], website_sale_order.currency_id, website_sale_order.company_id, date)"/>
                            <t groups="account.group_show_line_subtotals_tax_excluded" t-if="(website_sale_order.pricelist_id.discount_policy == 'without_discount' and website_sale_order.currency_id.compare_amounts(list_price_converted, line.price_reduce_taxexcl) == 1) or website_sale_order.currency_id.compare_amounts(line.price_unit, line.price_reduce) == 1" name="order_line_discount">
                                <del t-attf-class="#{'text-danger mr8'}" style="white-space: nowrap;" t-esc="list_price_converted" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" />
                            </t>
                            <span t-field="line.price_reduce_taxexcl" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" groups="account.group_show_line_subtotals_tax_excluded" />
                            <t groups="account.group_show_line_subtotals_tax_included" t-if="(website_sale_order.pricelist_id.discount_policy == 'without_discount' and website_sale_order.currency_id.compare_amounts(list_price_converted, line.price_reduce_taxinc) == 1) or website_sale_order.currency_id.compare_amounts(line.price_unit, line.price_reduce) == 1" name="order_line_discount">
                                <del t-attf-class="#{'text-danger mr8'}" style="white-space: nowrap;" t-esc="list_price_converted" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" />
                            </t>
                            <span t-field="line.price_reduce_taxinc" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" groups="account.group_show_line_subtotals_tax_included" />
                        </td>
                        <td class="text-center td-price">
                            <span t-field="line.product_uom" style="white-space: nowrap;" />
                        </td>
                        <td class="td-action"  name="product_oum">
                            <a href='#' aria-label="Remove from cart" title="Remove from cart" class='js_delete_product no-decoration'> <small><i class='fa fa-trash-o'></i></small></a>
                        </td>
                    </tr>
                </t>
            </tbody>
        </table>
        </xpath>
    </template>

    <template id="dnk_assets_frontend" inherit_id="website.assets_frontend">
        <xpath expr="script[last()]" position="after">
            <script type="text/javascript" src="/dnk_website_sale/static/src/js/website_sale.js"></script>
        </xpath>
    </template>

    <template id="dnk_website_product_price" inherit_id="website_sale.product_price">
        <xpath expr="//div[hasclass('product_price')]" position="replace">
            <div itemprop="offers" itemscope="itemscope" itemtype="http://schema.org/Offer" class="product_price mt16 te_prod_bottom_margin">
                <!--<t t-set="product_oum" t-value="line.product_id.product_uom"/>-->
                <t t-set="difference" t-value="round(combination_info['list_price'] - combination_info['price'],2)"/>
                <t t-set="discount" t-value="round(difference*100/combination_info['list_price']) if combination_info['list_price'] &gt; 0 else 0"/>
                <h4 class="oe_price_h4 css_editable_mode_hidden">
                    <t t-if="combination_info['product_uom_qty'] == 0">
                        <b class="oe_price" style="white-space: nowrap; " id="b_price" t-esc="combination_info['price']" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                    </t>
                    <t t-if="combination_info['product_uom_qty'] == 1">
                        <b class="oe_price" style="white-space: nowrap; display:none; " id="b_price" t-esc="combination_info['price']" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                        <span class="oe_price_uom oe_price" style="white-space: nowrap;" /> <span class="oe_currency_uom oe_price" t-esc="website.currency_id.name" />
                    </t>


                    <span t-attf-class="text-danger oe_default_price {{'' if combination_info['has_discounted_price'] else 'd-none'}}" style="text-decoration: line-through; white-space: nowrap;" t-esc="combination_info['list_price']" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                    <span itemprop="price" style="display:none;" t-esc="combination_info['price']"/>

                    <span itemprop="priceCurrency"  style="display:none;" t-esc="website.currency_id.name"/>
                </h4>
                <div t-if="combination_info['has_discounted_price']" class="te_discount">
                    <span class="te_prod_discount">You Save :</span>
                    <t t-esc="difference" t-options="{&quot;widget&quot;: &quot;monetary&quot;,                         &quot;display_currency&quot;: website.currency_id, }"/>
                    <span class="te_percentage" t-esc="'(%s'%(discount)+'%)'"/>
                </div>
            </div>
        </xpath>
    </template>

    <!-- solo si está instalado el tema de aviat-->
    <template id="dnk_website_product_details" inherit_id="website_sale.product">
        <xpath expr="//div[@id='product_details']" position="replace">
              <t t-set="buynow_enabled" t-value="request.website.viewref('website_sale.product_buy_now').active"/>
             <div class="col-md-6 col-xl-4" id="product_details">
                <h1 itemprop="name" t-field="product.name" class="product-name">Product Name</h1>
                <div class="product-page-description">
                    <t t-if="request.website.viewref('website_sale.products_description').active">
                        <p class="mb8" t-field="product.description_sale"/>
                    </t>
                </div>
                <span itemprop="url" style="display:none;" t-esc="product.website_url"/>
                <form t-if="product._is_add_to_cart_possible()" action="/shop/cart/update" method="POST">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />
                    <div class="js_product js_main_product">
                        <t t-placeholder="select">
                            <input type="hidden" class="product_id" name="product_id" t-att-value="product_variant.id" />
                            <input type="hidden" class="product_template_id" name="product_template_id" t-att-value="product.id" />
                            <t t-if="combination" t-call="sale.variants">
                                <t t-set="ul_class" t-value="'flex-column'" />
                                <t t-set="parent_combination" t-value="None" />
                            </t>
                            <t t-else="">
                                <ul class="d-none js_add_cart_variants" t-att-data-attribute_exclusions="{'exclusions: []'}"/>
                            </t>
                        </t>
                        <t t-call="website_sale.product_price" />
                        <p t-if="True" class="css_not_available_msg alert alert-warning">This combination does not exist.</p>
                            <t t-set="dnk_website_product_oum" t-value="product.get_website_product_uom()"/>
                            <t t-if="len(dnk_website_product_oum) &lt; 1">
                                <div class="css_quantity input-group align-items-center mt8 mb16" contenteditable="false">
                                    <span class="mr-3">Qty:</span>
                                    <div class="input-group-prepend">
                                        <a t-attf-href="#" class="btn btn-outline-secondary js_add_cart_json" aria-label="Remove one" title="Remove one">
                                            <i class="fa fa-minus"></i>
                                        </a>
                                    </div>
                                    <input type="text" class="form-control quantity" data-min="1" name="add_qty" t-att-value="add_qty or 1"/>
                                    <div class="input-group-append">
                                        <a t-attf-href="#" class="btn btn-outline-secondary float_left js_add_cart_json" aria-label="Add one" title="Add one">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                            </t>
                            <t t-if="len(dnk_website_product_oum) &gt; 0">
                                <input type="hidden" class="form-control quantity" data-min="1" name="add_qty" t-att-value="add_qty or 1"/>
                                <input type="hidden" class="form-control quantity" data-min="1" name="add_qty_uom" t-att-value="add_qty or 1"/>

                                <div class="css_quantity input-group align-items-center mt8 mb16" contenteditable="false">
                                    <span class="mr-3">Qty:</span>
                                    <div class="input-group-prepend">
                                        <a t-attf-href="#" class="btn btn-outline-secondary js_add_cart_json" aria-label="Remove one" title="Remove one">
                                            <i class="fa fa-minus"></i>
                                        </a>
                                    </div>

                                    <input type="text" style="text-align: center; max-width: 45px;" class="form-control quantity" id="qty_temp" t-att-value="add_qty or 1"/>

                                    <div class="input-group-prepend">
                                        <a t-attf-href="#" class="btn btn-outline-secondary float_left js_add_cart_json" aria-label="Add one" title="Add one">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                    <select id="product_uom" class="btn css_quantity" name="product_uom">
                                        <t t-foreach="dnk_website_product_oum" t-as="uom">
                                            <option t-att-value="uom.id">
                                                <t t-esc="uom.name" />
                                            </option>
                                        </t>
                                    </select>
                                    <div style="display:none;">
                                        <select id="product_uom_factor" class="btn css_quantity product_uom_factor" name="product_uom_factor">
                                            <t t-foreach="dnk_website_product_oum" t-as="uom">
                                                <option t-att-value="uom.id">
                                                    <t t-esc="uom.factor_inv" />
                                                </option>
                                            </t>
                                        </select>
                                    </div>
                                </div>

                            </t>
                            <t t-if="request.website.viewref('website_sale_comparison.add_to_compare').active">
                                <t t-set="product_variant" t-value="product_variant or product._create_first_product_variant()"/>
                                <button t-if="product_variant" type="button" role="button" class="btn btn-outline-secondary ml8 mr8 o_add_compare_dyn" aria-label="Compare" t-att-data-product-product-id="product_variant.id" data-action="o_comparelist"><span class="icon icon-ExitFullScreen"></span></button>
                            </t>

                            <!--
                            <t t-if="request.env.ref('website_sale_wishlist.add_to_wishlist').active">
                                <a type="button" role="button"
                                class="btn btn-outline-secondary o_add_wishlist "
                                t-att-disabled='in_wish or None' title="Add to Wishlist"
                                t-att-data-product-product-id="product.product_variant_ids[0].id if product.product_variant_ids else '0'"
                                data-action="o_wishlist">
                                    <span class="icon icon-Heart" role="img" aria-label="Add to wishlist"></span>
                                </a>
                            </t>-->
                        <a role="button" id="add_to_cart" class="btn btn-primary btn-lg js_check_product a-submit d-block d-sm-inline-block mr-md-2 mb-2 mb-md-0" href="#"> Add to Cart</a>
                        <div class="availability_messages o_not_editable"/>
                         <t t-if="buynow_enabled">
	                    	<a role="button" id="buy_now" class="btn btn-outline-primary btn-lg d-block d-sm-inline-block" href="#">Buy Now</a>
                    	</t>
                    <div id="product_option_block"/>
                    </div>
                </form>
		                <p t-elif="not product.active" class="alert alert-warning">This product is no longer available.</p>
		                <p t-else="" class="alert alert-warning">This product has no valid combination.</p>
		                <div>

                    <div id="product_attributes_simple">
                        <hr t-if="sum([(1 if len(l.value_ids)==1 else 0) for l in product.attribute_line_ids])"/>
                        <p class="text-muted">
                            <t t-set="single_value_attributes" t-value="product.valid_product_template_attribute_line_ids._prepare_single_value_for_display()"/>
                            <t t-foreach="single_value_attributes" t-as="attribute">
                                <span t-field="attribute.name"/>:
                                <t t-foreach="single_value_attributes[attribute]" t-as="ptal">
                                    <span t-field="ptal.product_template_value_ids._only_active().name"/><t t-if="not ptal_last">, </t>
                                </t>
                                <br/>
                            </t>
                        </p>
                    </div>
                </div>
                <hr />
            </div>
        </xpath>
    </template>
</odoo>
