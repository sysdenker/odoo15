<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="dnk_view_sale_order_line_tree" model="ir.ui.view">
        <field name="name">dnk.view.sale.order.line.tree</field>
        <field name="model">sale.order.line</field>
        <field name="priority" eval="1"/>
        <field name="arch" type="xml">
            <!--<tree string="Sale Orders Lines" create="false" delete="false" decoration-bf="dnk_final_commitment_date&lt;current_date">-->
            <tree string="Sale Orders Lines" create="false" delete="false">
                <field name="order_id"/>
                <field name="order_partner_id"/>
                <!-- We do not display the type because we don't want the user to be bothered with that information if he has no section or note. -->
                <field name="display_type" invisible="1"/>
                <field name="product_uom_category_id" invisible="1"/>

                <field name="product_updatable" invisible="1"/>
                <field
                    name="product_id"
                    attrs="{
                        'readonly': [('product_updatable', '=', False)],
                        'required': [('display_type', '=', False)],
                    }"
                    options="{'no_open': True}"
                    force_save="1"
                    context="{
                        'partner_id': parent.partner_id,
                        'quantity': product_uom_qty,
                        'pricelist': parent.pricelist_id,
                        'uom':product_uom,
                        'company_id': parent.company_id,
                        'default_lst_price': price_unit,
                        'default_description_sale': name
                    }"
                    domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                    widget="product_configurator"
                />
                <field name="product_template_id"
                  string="Product"
                  invisible="1"
                  attrs="{
                      'readonly': [('product_updatable', '=', False)],
                      'required': [('display_type', '=', False)],
                  }"
                  options="{'no_open': True}"
                  context="{
                      'partner_id': parent.partner_id,
                      'quantity': product_uom_qty,
                      'pricelist': parent.pricelist_id,
                      'uom':product_uom,
                      'company_id': parent.company_id,
                      'default_list_price': price_unit,
                      'default_description_sale': name
                  }"
                  domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                  widget="product_configurator"/>
                <field name="name" widget="section_and_note_text" optional="show" invisible="1"/>
                <field
                    name="analytic_tag_ids"
                    optional="hide"
                    groups="analytic.group_analytic_tags"
                    widget="many2many_tags"
                    options="{'color_field': 'color'}"
                    domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                />
                <field
                    name="product_uom_qty"
                    context="{
                        'partner_id': parent.partner_id,
                        'quantity': product_uom_qty,
                        'pricelist': parent.pricelist_id,
                        'uom': product_uom,
                        'company_id': parent.company_id
                    }"
                />
                <field
                    name="qty_delivered"
                    string="Delivered"
                    attrs="{
                        'readonly': [('qty_delivered_method', '!=', 'manual')]
                    }"
                    optional="show"
                />
                <field name="qty_invoiced" optional="show"/>
                <field name="invoice_status" optional="show"/>
                <field name="qty_delivered_manual" invisible="1"/>
                <field name="qty_delivered_method" invisible="1"/>
                <field
                    name="qty_invoiced"
                    string="Invoiced"
                    attrs="{'column_invisible': [('state', 'not in', ['sale', 'done'])]}"
                    optional="show"
                />
                <field name="qty_to_invoice" invisible="1"/>
                <field
                    name="product_uom"
                    force_save="1"
                    string="UoM"
                    attrs="{
                        'readonly': [('state', 'in', ('sale','done', 'cancel'))],
                        'required': [('display_type', '=', False)],
                    }"
                    context="{'company_id': parent.company_id}"
                    groups="uom.group_uom"
                    options='{"no_open": True}'
                    optional="show"
                />
                <field
                    name="customer_lead"
                    optional="hide"
                    attrs="{'readonly': [('state', 'not in', ['draft', 'sent'])]}"
                />
                <field
                    name="price_unit"
                    attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"
                />
                <!--<field
                    name="tax_id"
                    widget="many2many_tags"
                    options="{'no_create': True}"
                    domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                    attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"
                    optional="show"
                />-->
                <field name="dnk_subfamily_id" optional="show"/>
                <field name="dnk_family_id" optional="show"/>
                <field name="dnk_color_id" optional="show"/>
                <field name="order_warehouse_id" optional="show"/>
                <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line" optional="show"/>
                <field name="price_subtotal" widget="monetary" groups="account.group_show_line_subtotals_tax_excluded"/>
                <field name="price_total" widget="monetary" groups="account.group_show_line_subtotals_tax_included"/>
                <field name="state" invisible="1"/>
                <field name="invoice_status" invisible="1"/>
                <field name="currency_id" invisible="1"/>
                <field name="price_tax" invisible="1"/>
                <field name="company_id" invisible="1"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="dnk_view_sale_order_line_form" model="ir.ui.view">
        <field name="name">dnk.view.sale.order.line.form</field>
        <field name="model">sale.order.line</field>
        <field eval="1" name="priority"/>
        <field name="arch" type="xml">
            <form string="Sales Order" create="false" edit="true">
                <!-- Displayed fields -->
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="draft,posted"/>
                </header>
                <sheet>
                    <!--<div class="oe_button_box" name="button_box">
                        <button name="action_view_invoice" type="object" class="oe_stat_button" icon="fa-pencil-square-o" attrs="{'invisible': [('invoice_count', '=', 0)]}">
                            <field name="invoice_count" widget="statinfo" string="Invoices"/>
                        </button>
                    </div>-->
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <field name="display_type" invisible="1"/>
                    <!--
                        We need the sequence field to be here for new lines to be added at the correct position.
                        TODO: at some point we want to fix this in the framework so that an invisible field is not required.
                    -->
                    <field name="sequence" invisible="1"/>
                    <field name="product_uom_category_id" invisible="1"/>
                    <group>
                        <group attrs="{'invisible': [('display_type', '!=', False)]}">
                            <field name="product_updatable" invisible="1"/>
                            <field name="product_id"
                                domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                                context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                                attrs="{
                                    'readonly': ['|', ('product_updatable', '=', False), ('state', 'in', ('sale', 'done', 'cancel'))],
                                    'required': [('display_type', '=', False)],
                                }"
                                force_save="1"
                                widget="many2one_barcode"
                               />
                            <field name="invoice_status" invisible="1"/>
                            <field name="qty_to_invoice" invisible="1"/>
                            <field name="qty_delivered_manual" invisible="1"/>
                            <field name="qty_delivered_method" invisible="1"/>
                            <field name="price_total" invisible="1"/>
                            <field name="price_tax" invisible="1"/>
                            <field name="price_subtotal" invisible="1"/>
                            <label for="product_uom_qty"/>
                            <div class="o_row" name="ordered_qty">
                                <field
                                    context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'uom_qty_change':True, 'company_id': parent.company_id}"
                                    name="product_uom_qty" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                                <field
                                    name="product_uom"
                                    force_save="1"
                                    groups="uom.group_uom"
                                    class="oe_no_button"
                                    attrs="{
                                        'readonly': [('state', 'in', ('sale', 'done', 'cancel'))],
                                        'required': [('display_type', '=', False)],
                                    }"
                                />
                            </div>
                            <label for="qty_delivered" string="Delivered" attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}"/>
                            <div name="delivered_qty" attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}">
                                <field name="qty_delivered" attrs="{'readonly': ['|', ('qty_delivered_method', '!=', 'manual'), ('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            </div>
                            <label for="qty_invoiced" string="Invoiced" attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}"/>
                            <div name="invoiced_qty" attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}">
                                <field name="qty_invoiced" attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}"/>
                            </div>
                            <field name="price_unit" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="tax_id" widget="many2many_tags" options="{'no_create': True}" context="{'search_view_ref': 'account.account_tax_view_search'}" domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                                attrs="{'readonly': ['|', ('qty_invoiced', '&gt;', 0), ('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <label for="discount" groups="product.group_discount_per_so_line"/>
                            <div name="discount" groups="product.group_discount_per_so_line">
                                <field name="discount" class="oe_inline" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/> %%
                            </div>
                            <!--
                                We need the sequence field to be here
                                because we want to be able to overwrite the default sequence value in the JS
                                in order for new lines to be added at the correct position.
                                NOTE: at some point we want to fix this in the framework so that an invisible field is not required.
                            -->
                            <field name="sequence" invisible="1"/>
                            <field name="dnk_subfamily_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="dnk_family_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="dnk_color_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                        </group>
                        <group attrs="{'invisible': [('display_type', '!=', False)]}">
                            <field name="order_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="order_partner_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="qty_invoiced"/>
                            <field name="price_subtotal" widget="monetary" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <field name="invoice_status" optional="show"/>
                            <field name="salesman_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <field name="team_id"/>
                            <field name="order_warehouse_id" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                            <label for="customer_lead"/>
                            <div name="lead">
                                <field name="customer_lead" class="oe_inline" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/> days
                            </div>
                            <field name="analytic_tag_ids" widget="many2many_tags" groups="analytic.group_analytic_tags" options="{'color_field': 'color'}" domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                        </group>
                    </group>
                    <label for="name" string="Description" attrs="{'invisible': [('display_type', '!=', False)]}"/>
                    <label for="name" string="Section Name (eg. Products, Services)" attrs="{'invisible': [('display_type', '!=', 'line_section')]}"/>
                    <label for="name" string="Note" attrs="{'invisible': [('display_type', '!=', 'line_note')]}"/>
                    <field name="name" attrs="{'readonly': [('state', 'in', ('sale', 'done', 'cancel'))]}"/>
                    <div name="invoice_lines" groups="base.group_no_one" attrs="{'invisible': [('display_type', '!=', False)]}">
                        <label for="invoice_lines"/>
                        <field name="invoice_lines"/>
                    </div>
                    <field name="company_id" invisible="1"/>
                </sheet>
            </form>
        </field>
    </record>

    <record id="dnk_view_sale_order_line_kanban" model="ir.ui.view">
        <field name="name">dnk.view.sale.order.line.kanban</field>
        <field name="model">sale.order.line</field>
        <field eval="1" name="priority"/>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="order_id"/>
                <field name="order_partner_id"/>
                <field name="product_id"/>
                <field name="product_uom_qty"/>
                <field name="product_uom" groups="uom.group_uom"/>
                <field name="price_subtotal"/>
                <field name="price_tax" invisible="1"/>
                <field name="price_total" invisible="1"/>
                <field name="price_unit"/>
                <field name="display_type"/>
                <field name="tax_id" invisible="1"/>
                <field name="company_id" invisible="1"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click {{ record.display_type.raw_value ? 'o_is_' + record.display_type.raw_value : '' }}">
                            <t t-if="!record.display_type.raw_value">
                                <div class="row">
                                    <div class="col-8">
                                        <strong>
                                            <span>
                                                <t t-esc="record.order_id.value"/>
                                            </span>
                                        </strong>
                                    </div>
                                    <div class="col-8">
                                        <strong>
                                            <span>
                                                <t t-esc="record.order_partner_id.value"/>
                                            </span>
                                        </strong>
                                    </div>
                                    <div class="col-8">
                                        <strong>
                                            <span>
                                                <t t-esc="record.product_id.value"/>
                                            </span>
                                        </strong>
                                    </div>
                                    <div class="col-4">
                                        <strong>
                                            <span class="float-right text-right">
                                                <t t-esc="record.price_subtotal.value"/>
                                            </span>
                                        </strong>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 text-muted">
                                        <span>
                                            Quantity:
                                            <t t-esc="record.product_uom_qty.value"/>
                                            <t t-esc="record.product_uom.value"/>
                                        </span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 text-muted">
                                        <span>
                                            Unit Price:
                                            <t t-esc="record.price_unit.value"/>
                                        </span>
                                    </div>
                                </div>
                            </t>
                            <t t-if="record.display_type.raw_value === 'line_section' || record.display_type.raw_value === 'line_note'">
                                <div class="row">
                                    <div class="col-12">
                                        <span>
                                            <t t-esc="record.name.value"/>
                                        </span>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="dnk_view_sale_order_line_filter" model="ir.ui.view">
        <field name="name">dnk.view.sale.order.line.filter</field>
        <field name="model">sale.order.line</field>
        <field name="arch" type="xml">
            <search string="Sale Orders Lines">
                <field name="name" string="Sales Order Line" filter_domain="['|','|','|',('name','ilike',self),('order_id.client_order_ref','ilike',self),('order_partner_id','child_of',self)]"/>
                <field name="order_id" string="Sales Order"/>
                <field name="order_partner_id" operator="child_of"/>
                <field name="salesman_id"/>
                <field name="team_id" string="Sales Channel"/>
                <field name="product_id"/>
                <separator/>
                <filter string="Unread Messages" name="message_needaction" domain="[('order_id.message_needaction','=',True)]"/>
                <separator/>
                <filter string="My Activities" name="activities_my" domain="[('order_id.activity_ids.user_id', '=', uid)]"/>
                <separator/>
                <filter string="Late Activities" name="activities_overdue" domain="[('order_id.activity_ids.date_deadline', '&lt;', context_today().strftime('%Y-%m-%d'))]" help="Show all records which has next action date is before today"/>
                <filter string="Today Activities" name="activities_today" domain="[('order_id.activity_ids.date_deadline', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Future Activities" name="activities_upcoming_all" domain="[('order_id.activity_ids.date_deadline', '&gt;', context_today().strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Group By">
                    <filter string="Sale Order" name="sale_order" domain="[]" context="{'group_by': 'order_id'}"/>
                    <filter string="Salesperson" name="salesperson" domain="[]" context="{'group_by': 'salesman_id'}"/>
                    <filter name="customer" string="Customer" domain="[]" context="{'group_by': 'order_partner_id'}"/>
                    <filter string="- Subfamily" domain="[]" context="{'group_by':'dnk_subfamily_id'}" name="dnk_subfamily_id"/>
                    <filter string="- Family" domain="[]" context="{'group_by':'dnk_family_id'}" name="dnk_family_id"/>
                    <filter string="- Color" domain="[]" context="{'group_by':'dnk_color_id'}" name="dnk_color_id"/>
                    <filter string="Warehouse" domain="[]" context="{'group_by':'order_warehouse_id'}" name="order_warehouse_id"/>
                </group>
                <separator/>
                <filter string="Sales" name="sales" domain="[('state','in',('progress','done'))]"/>
           </search>
        </field>
    </record>

    <record id="action_sale_order_line" model="ir.actions.act_window">
        <field name="name">Sale Orders Lines</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order.line</field>
        <field name="context">{}</field>
        <!--<field name="view_mode">tree,form,pivot</field>-->
        <field name="view_mode">tree,form,kanban</field>
        <field name="search_view_id" ref="dnk_view_sale_order_line_filter"/>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
            </p>
        </field>
    </record>

    <record id="action_sale_order_line_tree" model="ir.actions.act_window.view">
        <field eval="1" name="sequence"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="dnk_view_sale_order_line_tree"/>
        <field name="act_window_id" ref="action_sale_order_line"/>
    </record>

    <record id="action_sale_order_line_form" model="ir.actions.act_window.view">
        <field eval="3" name="sequence"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="dnk_view_sale_order_line_form"/>
        <field name="act_window_id" ref="action_sale_order_line"/>
    </record>

    <record id="action_sale_order_line_kanban" model="ir.actions.act_window.view">
        <field eval="3" name="sequence"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="dnk_view_sale_order_line_kanban"/>
        <field name="act_window_id" ref="action_sale_order_line"/>
    </record>

    <menuitem action="action_sale_order_line" name="- Sale Orders Lines"
        id="menu_sale_order_line" parent="sale.sale_order_menu"
        sequence="0"/>

    <!--<menuitem action="action_sale_order_line" name="- Sale Orders Lines"
        id="menu_sale_order_line_on_mrp" parent="mrp.menu_mrp_manufacturing"
        sequence="5"/>-->

    <!--<menuitem action="action_sale_order_line" name="- Sale Orders Lines"
        id="menu_sale_order_line_on_purchase" parent="purchase.menu_purchase_control"
        sequence="5"/>-->
</odoo>
